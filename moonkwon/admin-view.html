<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Admin - View All Bookings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header h1 i {
            color: #ffd700;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .controls {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .bookings-table {
            padding: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f5f9ff;
        }
        
        .booking-id {
            font-family: monospace;
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .username {
            font-weight: bold;
            color: #3498db;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
        }
        
        .no-bookings {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }
        
        .no-bookings i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #bdc3c7;
        }
        
        .filter-bar {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            min-width: 200px;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .timestamp {
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .controls {
                justify-content: center;
            }
            
            .filter-group {
                justify-content: center;
            }
            
            .filter-group input,
            .filter-group select {
                min-width: 100%;
            }
            
            th, td {
                padding: 10px;
                font-size: 14px;
            }
        }
        
        .color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .meetup-indicator { background: #3498db; }
        .selfcollect-indicator { background: #27ae60; }
        
        .export-options {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }
        
        .export-options.show {
            display: block;
        }
        
        .json-preview {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .refresh-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        
        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-info {
            font-family: monospace;
            margin-top: 10px;
            font-size: 11px;
            color: #bdc3c7;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="refresh-status" id="refreshStatus">
        <i class="fas fa-sync-alt fa-spin"></i> Refreshing...
    </div>
    
    <div class="debug-panel" id="debugPanel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <strong>Debug Info</strong>
            <button onclick="toggleDebug()" style="padding: 2px 8px; font-size: 10px;">Close</button>
        </div>
        <div class="debug-info" id="debugInfo"></div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-calendar-alt"></i>
                Booking System - Admin Dashboard
            </h1>
            <p>View and manage all booking records</p>
            <div style="margin-top: 15px; font-size: 14px; opacity: 0.8;">
                <button onclick="toggleDebug()" style="padding: 5px 10px; font-size: 12px; background: #34495e;">
                    <i class="fas fa-bug"></i> Debug Panel
                </button>
                <button onclick="checkStorage()" style="padding: 5px 10px; font-size: 12px; background: #8e44ad; margin-left: 10px;">
                    <i class="fas fa-database"></i> Check Storage
                </button>
            </div>
        </div>
        
        <div class="stats" id="statsContainer">
            <!-- Stats will be loaded here -->
        </div>
        
        <div class="controls">
            <button class="btn-primary" onclick="loadBookings()" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn-success" onclick="exportToCSV()">
                <i class="fas fa-file-csv"></i> Export to CSV
            </button>
            <button class="btn-warning" onclick="exportToJSON()">
                <i class="fas fa-file-code"></i> Export to JSON
            </button>
            <button class="btn-danger" onclick="clearAllBookings()">
                <i class="fas fa-trash-alt"></i> Clear All
            </button>
            <button class="btn-primary" onclick="showExportOptions()">
                <i class="fas fa-cog"></i> More Options
            </button>
        </div>
        
        <div class="export-options" id="exportOptions">
            <h3>Export Options</h3>
            <div class="filter-group">
                <button onclick="exportByDateRange()">Export by Date Range</button>
                <button onclick="exportByType('meetup')">Export Meetups Only</button>
                <button onclick="exportByType('selfcollect')">Export Self-Collect Only</button>
                <button onclick="exportTodayBookings()">Export Today's Bookings</button>
            </div>
            <div id="jsonPreview" class="json-preview"></div>
        </div>
        
        <div class="filter-bar">
            <div class="filter-group">
                <input type="text" id="searchInput" placeholder="Search by username or listing..." 
                       onkeyup="filterBookings()">
                <select id="typeFilter" onchange="filterBookings()">
                    <option value="">All Types</option>
                    <option value="meetup">Meetup</option>
                    <option value="selfcollect">Self Collect</option>
                </select>
                <select id="dateFilter" onchange="filterBookings()">
                    <option value="">All Dates</option>
                </select>
                <button onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
        </div>
        
        <div class="bookings-table">
            <div id="bookingsList">
                <!-- Bookings will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Store filtered bookings globally for delete reference
        let currentDisplayedBookings = [];
        let refreshInterval;
        
        // Load bookings on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Admin panel initializing...');
            loadBookings();
            updateDateFilter();
            
            // Start auto-refresh every 10 seconds
            refreshInterval = setInterval(loadBookings, 10000);
            
            // Check storage on load
            checkStorage();
        });
        
        // Show refresh status
        function showRefreshStatus() {
            const status = document.getElementById('refreshStatus');
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 2000);
        }
        
        // Load all bookings from localStorage
        function loadBookings() {
            console.log('üîÑ Loading bookings from localStorage...');
            try {
                const bookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
                console.log(`üìä Found ${bookings.length} bookings in storage`);
                
                currentDisplayedBookings = bookings; // Store the original array
                displayStats(bookings);
                displayBookings(bookings);
                populateDateFilter(bookings);
                
                // Update debug info
                updateDebugInfo(bookings);
                
                // Show refresh status
                showRefreshStatus();
                
            } catch (error) {
                console.error('‚ùå Error loading bookings:', error);
                document.getElementById('bookingsList').innerHTML = `
                    <div class="no-bookings">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Bookings</h3>
                        <p>${error.message}</p>
                        <button onclick="checkStorage()" style="margin-top: 20px;" class="btn-primary">
                            <i class="fas fa-database"></i> Check Storage
                        </button>
                    </div>
                `;
            }
        }
        
        // Display statistics
        function displayStats(bookings) {
            const statsContainer = document.getElementById('statsContainer');
            const total = bookings.length;
            
            // Count by type
            const meetups = bookings.filter(b => 
                b.type && b.type.toLowerCase().includes('meetup')).length;
            const selfcollect = bookings.filter(b => 
                b.type && b.type.toLowerCase().includes('self')).length;
            
            // Count today's bookings
            const today = new Date();
            const todayStr = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
            const todayBookings = bookings.filter(b => b.date === todayStr).length;
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${meetups}</div>
                    <div class="stat-label">Meetups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${selfcollect}</div>
                    <div class="stat-label">Self Collect</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${todayBookings}</div>
                    <div class="stat-label">Today's Bookings</div>
                </div>
            `;
        }
        
        // Display bookings in table
        function displayBookings(bookings, filtered = false) {
            const bookingsList = document.getElementById('bookingsList');
            
            if (bookings.length === 0) {
                bookingsList.innerHTML = `
                    <div class="no-bookings">
                        <i class="fas fa-calendar-times"></i>
                        <h3>No Bookings Found</h3>
                        <p>${filtered ? 'Try changing your filters' : 'No bookings have been made yet.'}</p>
                        <div style="margin-top: 20px;">
                            <button onclick="checkStorage()" class="btn-primary">
                                <i class="fas fa-database"></i> Check Storage
                            </button>
                            <button onclick="window.open('index.html', '_blank')" class="btn-success" style="margin-left: 10px;">
                                <i class="fas fa-plus"></i> Make a Booking
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Store the displayed bookings for delete reference
            currentDisplayedBookings = bookings;
            
            // Sort by timestamp (newest first)
            bookings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date & Time</th>
                            <th>Username</th>
                            <th>Listings</th>
                            <th>Location</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            bookings.forEach((booking) => {
                const date = new Date(booking.timestamp);
                const dateStr = date.toLocaleDateString('en-GB');
                const timeStr = date.toLocaleTimeString('en-GB', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Determine color indicator based on type
                const typeIndicator = booking.type && booking.type.toLowerCase().includes('meetup') 
                    ? 'meetup-indicator' 
                    : 'selfcollect-indicator';
                
                // Truncate listings if too long
                const listings = booking.listings || '';
                const shortListings = listings.length > 50 
                    ? listings.substring(0, 50) + '...' 
                    : listings;
                
                tableHTML += `
                    <tr>
                        <td>
                            <span class="booking-id">${booking.id || 'N/A'}</span>
                        </td>
                        <td>
                            <div>${booking.date || 'N/A'} ${booking.time || ''}</div>
                            <div class="timestamp">${dateStr} ${timeStr}</div>
                        </td>
                        <td>
                            <span class="username">${booking.username || 'N/A'}</span>
                        </td>
                        <td title="${listings}">${shortListings}</td>
                        <td>${booking.location || 'N/A'}</td>
                        <td>
                            <span class="color-indicator ${typeIndicator}"></span>
                            ${booking.type || 'N/A'}
                        </td>
                        <td>
                            <span class="status-badge status-confirmed">Confirmed</span>
                        </td>
                        <td class="actions">
                            <button class="action-btn btn-primary" onclick="viewBookingDetails('${booking.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn btn-danger" onclick="deleteBooking('${booking.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            bookingsList.innerHTML = tableHTML;
        }
        
        // View booking details
        function viewBookingDetails(bookingId) {
            const bookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
            const booking = bookings.find(b => b.id === bookingId);
            
            if (!booking) {
                alert('Booking not found');
                return;
            }
            
            const date = new Date(booking.timestamp);
            const details = `
üìã **BOOKING DETAILS**

üî∏ ID: ${booking.id}
üî∏ Username: ${booking.username}
üî∏ Date: ${booking.date}
üî∏ Time: ${booking.time}
üî∏ Location: ${booking.location}
üî∏ Type: ${booking.type}
üî∏ Listings: ${booking.listings}
üî∏ Created: ${date.toLocaleString()}
üî∏ Status: ${booking.status}

üìä **STORAGE INFO**
üî∏ Total bookings in system: ${bookings.length}
üî∏ Storage location: localStorage
üî∏ Key: all_bookings

            `;
            
            alert(details);
        }
        
        // Delete a booking by ID
        function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking?')) {
                return;
            }
            
            const bookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
            
            // Find the booking to get details for confirmation message
            const bookingToDelete = bookings.find(b => b.id === bookingId);
            
            if (!bookingToDelete) {
                alert('Booking not found');
                return;
            }
            
            // Remove the booking by ID (not by index)
            const updatedBookings = bookings.filter(b => b.id !== bookingId);
            
            // Save back to localStorage
            localStorage.setItem('all_bookings', JSON.stringify(updatedBookings));
            
            // Reload the bookings display
            loadBookings();
            
            alert(`‚úÖ Deleted booking for ${bookingToDelete.username} (ID: ${bookingToDelete.id})`);
        }
        
        // Clear all bookings
        function clearAllBookings() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL bookings permanently!\n\nAre you absolutely sure?')) {
                return;
            }
            
            localStorage.removeItem('all_bookings');
            localStorage.removeItem('bookings_pending');
            localStorage.removeItem('bookings_success');
            
            alert('‚úÖ All bookings have been cleared.');
            loadBookings();
        }
        
        // Export to CSV
        function exportToCSV() {
            const bookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
            
            if (bookings.length === 0) {
                alert('No bookings to export');
                return;
            }
            
            // Create CSV headers
            let csv = 'ID,Timestamp,Username,Listings,Date,Time,Location,Type,Status\n';
            
            // Add rows
            bookings.forEach(booking => {
                const row = [
                    booking.id || '',
                    booking.timestamp || '',
                    `"${(booking.username || '').replace(/"/g, '""')}"`,
                    `"${(booking.listings || '').replace(/"/g, '""')}"`,
                    booking.date || '',
                    booking.time || '',
                    booking.location || '',
                    booking.type || '',
                    booking.status || ''
                ];
                
                csv += row.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bookings_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Exported ${bookings.length} bookings to CSV`);
        }
        
        // Export to JSON
        function exportToJSON() {
            const bookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
            
            if (bookings.length === 0) {
                alert('No bookings to export');
                return;
            }
            
            const dataStr = JSON.stringify(bookings, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bookings_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Exported ${bookings.length} bookings to JSON`);
        }
        
        // Filter bookings
        function filterBookings() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            const allBookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
            
            const filtered = allBookings.filter(booking => {
                // Search term filter
                if (searchTerm) {
                    const inUsername = booking.username?.toLowerCase().includes(searchTerm);
                    const inListings = booking.listings?.toLowerCase().includes(searchTerm);
                    if (!inUsername && !inListings) return false;
                }
                
                // Type filter
                if (typeFilter) {
                    if (typeFilter === 'meetup') {
                        if (!booking.type?.toLowerCase().includes('meetup')) return false;
                    } else if (typeFilter === 'selfcollect') {
                        if (!booking.type?.toLowerCase().includes('self')) return false;
                    }
                }
                
                // Date filter
                if (dateFilter) {
                    if (booking.date !== dateFilter) return false;
                }
                
                return true;
            });
            
            displayBookings(filtered, true);
        }
        
        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('dateFilter').value = '';
            loadBookings();
        }
        
        // Populate date filter
        function populateDateFilter(bookings) {
            const dateFilter = document.getElementById('dateFilter');
            const dates = [...new Set(bookings.map(b => b.date).filter(Boolean))].sort();
            
            // Keep existing options
            const existingOptions = Array.from(dateFilter.options).map(opt => opt.value);
            
            // Add new dates
            dates.forEach(date => {
                if (!existingOptions.includes(date)) {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    dateFilter.appendChild(option);
                }
            });
        }
        
        // Update date filter options
        function updateDateFilter() {
            const dateFilter = document.getElementById('dateFilter');
            const today = new Date();
            const dateOptions = [];
            
            // Add next 30 days
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                dateOptions.push(dateStr);
            }
            
            // Add options
            dateOptions.forEach(dateStr => {
                if (!Array.from(dateFilter.options).some(opt => opt.value === dateStr)) {
                    const option = document.createElement('option');
                    option.value = dateStr;
                    option.textContent = dateStr;
                    dateFilter.appendChild(option);
                }
            });
        }
        
        // Show export options
        function showExportOptions() {
            const options = document.getElementById('exportOptions');
            options.classList.toggle('show');
            
            if (options.classList.contains('show')) {
                const bookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
                document.getElementById('jsonPreview').textContent = 
                    JSON.stringify(bookings.slice(0, 5), null, 2) + 
                    (bookings.length > 5 ? '\n... and ' + (bookings.length - 5) + ' more' : '');
            }
        }
        
        // Additional export functions
        function exportByDateRange() {
            const start = prompt('Enter start date (DD/MM/YYYY):');
            const end = prompt('Enter end date (DD/MM/YYYY):');
            
            if (!start || !end) return;
            
            const bookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
            const filtered = bookings.filter(b => {
                const [day, month, year] = b.date.split('/').map(Number);
                const bookingDate = new Date(year, month - 1, day);
                
                const [startDay, startMonth, startYear] = start.split('/').map(Number);
                const startDate = new Date(startYear, startMonth - 1, startDay);
                
                const [endDay, endMonth, endYear] = end.split('/').map(Number);
                const endDate = new Date(endYear, endMonth - 1, endDay);
                
                return bookingDate >= startDate && bookingDate <= endDate;
            });
            
            if (filtered.length === 0) {
                alert('No bookings found in this date range');
                return;
            }
            
            exportFiltered(filtered, `bookings_${start.replace(/\//g, '-')}_to_${end.replace(/\//g, '-')}.csv`);
        }
        
        function exportByType(type) {
            const bookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
            const filtered = bookings.filter(b => 
                type === 'meetup' 
                    ? b.type?.toLowerCase().includes('meetup')
                    : b.type?.toLowerCase().includes('self')
            );
            
            if (filtered.length === 0) {
                alert(`No ${type} bookings found`);
                return;
            }
            
            exportFiltered(filtered, `bookings_${type}_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportTodayBookings() {
            const today = new Date();
            const todayStr = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
            
            const bookings = JSON.parse(localStorage.getItem('all_bookings')) || [];
            const filtered = bookings.filter(b => b.date === todayStr);
            
            if (filtered.length === 0) {
                alert('No bookings for today');
                return;
            }
            
            exportFiltered(filtered, `bookings_today_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportFiltered(bookings, filename) {
            let csv = 'ID,Timestamp,Username,Listings,Date,Time,Location,Type,Status\n';
            
            bookings.forEach(booking => {
                const row = [
                    booking.id || '',
                    booking.timestamp || '',
                    `"${(booking.username || '').replace(/"/g, '""')}"`,
                    `"${(booking.listings || '').replace(/"/g, '""')}"`,
                    booking.date || '',
                    booking.time || '',
                    booking.location || '',
                    booking.type || '',
                    booking.status || ''
                ];
                
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Exported ${bookings.length} bookings`);
        }
        
        // Debug functions
        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.classList.toggle('show');
            
            if (debugPanel.classList.contains('show')) {
                checkStorage();
            }
        }
        
        function checkStorage() {
            const bookings = JSON.parse(localStorage.getItem('all_bookings') || '[]');
            const lastBooking = JSON.parse(sessionStorage.getItem('last_booking') || 'null');
            
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = `
üìä **STORAGE STATUS**

LocalStorage (all_bookings):
‚Ä¢ Total bookings: ${bookings.length}
‚Ä¢ Last updated: ${new Date().toLocaleTimeString()}

SessionStorage (last_booking):
‚Ä¢ ${lastBooking ? `User: ${lastBooking.username}` : 'No recent booking'}

üîç **RECENT BOOKINGS:**
${bookings.slice(0, 3).map((b, i) => 
    `${i + 1}. ${b.username} - ${b.date} ${b.time}`
).join('\n') || 'No bookings'}

üìù **STORAGE KEYS:**
${Object.keys(localStorage).map(key => 
    `‚Ä¢ ${key}: ${localStorage.getItem(key).length} chars`
).join('\n')}
            `;
            
            console.log('üìã Storage check:', {
                localStorage: bookings,
                sessionStorage: lastBooking
            });
        }
        
        function updateDebugInfo(bookings) {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.innerHTML = `
üìä Last refresh: ${new Date().toLocaleTimeString()}
üìà Total bookings: ${bookings.length}
üîÑ Auto-refresh: Every 10s
                `;
            }
        }
        
        // Print function
        window.printBookings = function() {
            window.print();
        };
        
        // Clear refresh interval on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>